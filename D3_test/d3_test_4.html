<!-- templates/map.html -->
<!DOCTYPE html>
<html>
<head>
    <title>D3 Map</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://d3js.org/d3.v6.min.js"></script>

</head>
<body>
<script>
d3.json("countries.geojson").then(function(geojson) {
    d3.csv("world_gdp.xlsx", { readAs: "binary" }).then(function(data) {
        const parsedData = Papa.parse(data, { header: true });
        const gdpData = parsedData.data.reduce((obj, row) => {
            obj[row.NAME] = +row.gdp_per_capita;
            return obj;
        }, {});

        const projection = d3.geoMercator().fitSize([width, height], geojson);
        const path = d3.geoPath().projection(projection);
        const colorScale = d3.scaleSequential(d3.interpolateGreens).domain([d3.min(parsedData, d => d.gdp_per_capita), d3.max(parsedData, d => d.gdp_per_capita)]);

        svg.selectAll("path")
           .data(geojson.features)
           .enter().append("path")
           .attr("d", path)
           .attr("fill", d => gdpData[d.properties.NAME] ? colorScale(gdpData[d.properties.NAME]) : "#eeeeee")
           .attr("stroke", "white")
           .attr("stroke-width", 0.5);

        // Legend - assuming setup exists for legendG variable
        const legendValues = d3.range(0, 1, 0.1).map(d => colorScale(d));
        const legendItemSize = 20;
        legendG.selectAll("rect")
               .data(legendValues)
               .enter().append("rect")
               .attr("x", 0)
               .attr("y", (d, i) => i * (legendItemSize + 3))
               .attr("width", legendItemSize)
               .attr("height", legendItemSize)
               .attr("fill", d => d);

        legendG.selectAll("text")
               .data(legendValues)
               .enter().append("text")
               .attr("x", legendItemSize + 5)
               .attr("y", (d, i) => i * (legendItemSize + 3) + legendItemSize / 2)
               .style("font-size", "10px")
               .text(d => `${d3.format(",")(Math.round(colorScale.invertExtent(d)[0]))} - ${d3.format(",")(Math.round(colorScale.invertExtent(d)[1]))}`);
    });
});

</script>
</body>
</html>